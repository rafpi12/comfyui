<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Model Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; }
        select, input { background: #111827 !important; color: white !important; border: 1px solid #475569 !important; padding: 10px !important; border-radius: 8px; font-size: 0.9rem !important; }
        #models-ui { min-height: 400px; font-family: monospace; }
        #log-console { height: 120px; overflow-y: auto; background: #000; color: #4ade80; font-family: monospace; font-size: 0.8rem; padding: 10px; border-radius: 8px; border: 1px solid #334155; }
        .btn-action { transition: all 0.2s; font-weight: bold; padding: 12px; border-radius: 10px; text-transform: uppercase; }
        .file-highlight { background: rgba(251, 191, 36, 0.1) !important; border-left: 4px solid #fbbf24 !important; }
        #github-toast { position: fixed; bottom: 20px; right: 20px; background: #16a34a; color: white; padding: 12px 20px; border-radius: 10px; display: flex; align-items: center; gap: 10px; transform: translateY(100px); transition: transform 0.3s ease; z-index: 1000; }
        #github-toast.show { transform: translateY(0); }
        #path-browser { position: absolute; width: 100%; top: 100%; left: 0; background: #1e293b; border: 1px solid #475569; border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 50; display: none; }
        .path-item { padding: 8px 12px; font-size: 11px; cursor: pointer; border-bottom: 1px solid #334155; }
        .path-item:hover { background: #334155; color: #60a5fa; }
    </style>
</head>
<body class="p-8">
    <div id="github-toast"><i class="fab fa-github"></i><span>Catalogue synchronisé !</span></div>
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-black text-blue-400 uppercase tracking-tighter">Model Manager Pro</h1>
            <div class="flex gap-3">
                <button onclick="fetch('/purge',{method:'POST'})" class="bg-slate-800 px-5 py-2 rounded-lg text-xs font-bold">PURGER ARIA2</button>
                <button onclick="location.reload()" class="bg-slate-800 px-5 py-2 rounded-lg text-xs font-bold">ACTUALISER</button>
            </div>
        </div>

        <div class="card p-8 mb-8 shadow-2xl border-t-4 border-blue-500">
            <div class="flex gap-4 mb-6">
                <select id="env-ui" class="w-1/4" onchange="loadModels()"></select>
                <select id="type-ui" class="w-1/4" onchange="loadModels()">
                    <option value="all">TOUTES CATÉGORIES</option>
                    <option value="diffusion_models">DIFFUSION MODELS</option>
                    <option value="loras">LORAS</option>
                    <option value="vae">VAE</option>
                    <option value="clip">CLIP / TEXT ENCODERS</option>
                    <option value="unet">UNET / GGUF</option>
                    <option value="upscale_models">UPSCALERS</option>
                    <option value="controlnet">CONTROLNET</option>
                </select>
                <input id="search-ui" type="text" placeholder="Rechercher..." class="flex-1" onkeyup="loadModels()">
            </div>
            <div class="bg-black/40 p-6 rounded-xl border border-slate-700">
                <div class="flex justify-between mb-4 items-center text-[10px]">
                    <div class="flex items-center gap-3">
                        <div id="diode-ui" class="w-3 h-3 rounded-full bg-red-500 transition-all duration-500"></div>
                        <span id="status-text" class="uppercase text-gray-400 font-bold">Inconnu</span>
                    </div>
                    <div id="path-ui" class="text-gray-500 italic truncate max-w-md">Prêt.</div>
                </div>
                <select id="models-ui" class="w-full mb-6" multiple onclick="syncToEditor()" onchange="checkStatus()"></select>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="startSmartDownload()" class="btn-action bg-blue-600 hover:bg-blue-500 shadow-lg">Télécharger</button>
                    <button id="delete-btn" onclick="deleteFromDisk()" class="btn-action bg-red-900/50 text-red-500 border border-red-500 opacity-20" disabled>Supprimer</button>
                </div>
            </div>
        </div>

        <div id="tasks-ui" class="space-y-3 mb-8"></div>

        <div class="card p-8 shadow-xl border-t-4 border-yellow-600 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold text-yellow-500 uppercase tracking-widest">Éditeur</h2>
                <button onclick="resetEditor()" class="text-[10px] bg-slate-700 px-2 py-1 rounded">VIDER</button>
            </div>
            <div class="grid grid-cols-2 gap-8">
                <div class="space-y-3 bg-black/20 p-5 rounded-xl">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="edit-env" class="w-full">
                            <option value="Z-Image">Z-Image</option><option value="Flux">Flux</option><option value="SDXL">SDXL</option><option value="Qwen">Qwen</option><option value="Wan">Wan</option>
                        </select>
                        <select id="edit-cat" class="w-full" onchange="updatePathByCategory()">
                            <option value="diffusion_models">diffusion_models</option><option value="loras">loras</option><option value="vae">vae</option><option value="clip">clip</option><option value="unet">unet</option><option value="text_encoders">text_encoders</option><option value="upscale_models">upscale_models</option><option value="controlnet">controlnet</option><option value="model_patches">model_patches</option>
                        </select>
                    </div>
                    <div class="relative">
                        <div class="flex items-center gap-2">
                            <input id="edit-path" placeholder="Chemin" class="flex-1 text-[10px]">
                            <button onclick="togglePathBrowser()" class="bg-slate-800 p-2 rounded hover:bg-slate-700"><i class="fas fa-folder-open text-blue-400"></i></button>
                        </div>
                        <div id="path-browser"></div>
                    </div>
                    <input id="edit-url" placeholder="URL" class="w-full text-xs" oninput="autoFetchName(this.value)">
                    <input id="edit-file" placeholder="Fichier" class="w-full bg-slate-900 text-xs font-bold">
                    <button onclick="saveToCatalogue()" class="w-full bg-yellow-600 py-2 rounded-lg font-bold text-sm">ENREGISTRER</button>
                </div>
                <div id="catalogue-list" class="space-y-1 text-[10px] bg-black/30 p-4 rounded-xl overflow-y-auto max-h-[250px]"></div>
            </div>
        </div>
        <div id="log-console"></div>
    </div>

    <script>
        const BASE_PATH = "/workspace/ComfyUI/models/";
        let cfg = {}; let diskFiles = {}; let lastCompleteCount = 0;

        function showGitHubToast() {
            const t = document.getElementById('github-toast');
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }

        function resetEditor() { document.getElementById('edit-url').value = ""; document.getElementById('edit-file').value = ""; document.getElementById('edit-path').value = ""; hidePathBrowser(); }
        function updatePathByCategory() { const cat = document.getElementById('edit-cat').value; document.getElementById('edit-path').value = BASE_PATH + cat; hidePathBrowser(); }
        async function togglePathBrowser() {
            const browser = document.getElementById('path-browser');
            if (browser.style.display === "block") hidePathBrowser();
            else {
                const cat = document.getElementById('edit-cat').value;
                const r = await fetch(`/list-subfolders?category=${cat}`);
                const folders = await r.json();
                browser.innerHTML = folders.map(f => `<div class="path-item flex items-center gap-2" onclick="setPath('${cat}', '${f}')">${f === "" ? '<span class="text-blue-400">⤴️</span> Dossier Racine' : '<i class="fas fa-folder text-yellow-500"></i> ' + f}</div>`).join('');
                browser.style.display = "block";
            }
        }
        function hidePathBrowser() { document.getElementById('path-browser').style.display = "none"; }
        function setPath(cat, sub) { const cleanSub = sub === "" ? "" : (sub.startsWith('/') ? sub : '/' + sub); document.getElementById('edit-path').value = BASE_PATH + cat + cleanSub; hidePathBrowser(); }
        async function autoFetchName(url) {
            const fileInput = document.getElementById('edit-file'); if (!url) return;
            fileInput.value = "⏳...";
            if (url.includes('huggingface.co')) fileInput.value = url.split('/').pop().split('?')[0];
            else if (url.includes('civitai.com')) {
                const r = await fetch(`/fetch-civitai-name?url=${encodeURIComponent(url)}`);
                const d = await r.json(); fileInput.value = d.filename || "";
            }
        }

        async function start() {
            try {
                const r = await fetch('/config'); cfg = await r.json();
                const envSelector = document.getElementById('env-ui'); envSelector.innerHTML = "";
                const environments = Object.keys(cfg);
                if (environments.length > 0) {
                    environments.forEach(env => envSelector.add(new Option(env, env)));
                    envSelector.value = environments.includes("Flux") ? "Flux" : environments[0];
                }
                await updateDiskState(); loadModels(); renderCatalogue(); setInterval(loop, 2000);
            } catch(e) { }
        }

        async function updateDiskState() { const r = await fetch('/scan-disk'); diskFiles = await r.json(); }

        function loadModels(targetFilename = null) {
            const m = document.getElementById('models-ui'); const env = document.getElementById('env-ui').value;
            const type = document.getElementById('type-ui').value; const search = document.getElementById('search-ui').value.toLowerCase();
            const savedScroll = m.scrollTop; const selectedValues = targetFilename ? [targetFilename] : Array.from(m.selectedOptions).map(o => o.value);
            m.innerHTML = ""; if (!cfg[env]) return;

            Object.keys(cfg[env]).forEach(cat => {
                let matchType = (type === 'all');
                if (!matchType) {
                    if (type === 'clip') matchType = (cat.includes('clip') || cat.includes('text_encoders'));
                    else if (type === 'unet') matchType = (cat.includes('unet') || cat.includes('diffusion_models'));
                    else matchType = cat.toLowerCase().includes(type.toLowerCase());
                }
                if (matchType) {
                    cfg[env][cat].forEach(model => {
                        if(model.filename.toLowerCase().includes(search)) {
                            const catKey = model.path.split('/')[0];
                            const sub = model.path.includes('/') ? model.path.split('/').slice(1).join('/') : '';
                            const diskCategoryFiles = diskFiles[catKey] || [];
                            const fullModelPath = (sub ? sub + '/' : '') + model.filename;
                            const isPresent = diskCategoryFiles.some(f => f.toLowerCase() === fullModelPath.toLowerCase());
                            let o = new Option((isPresent ? "● " : "○ ") + model.filename, model.filename);
                            o.dataset.url = model.url; o.dataset.cat = model.path; if(isPresent) o.style.color = "#4ade80";
                            if (selectedValues.includes(model.filename)) o.selected = true;
                            m.add(o);
                        }
                    });
                }
            });
            m.scrollTop = targetFilename ? (Array.from(m.options).findIndex(o => o.selected) * 24) : savedScroll;
        }

        async function checkStatus() {
            const s = Array.from(document.getElementById('models-ui').selectedOptions); const delBtn = document.getElementById('delete-btn'); if(s.length === 0) return;
            const o = s[0]; const name = o.value.replace(/^[●○]\s/, "");
            const r = await fetch(`/check-file?category=${encodeURIComponent(o.dataset.cat)}&filename=${encodeURIComponent(name)}`);
            const d = await r.json();
            document.getElementById('diode-ui').className = `w-3 h-3 rounded-full ${d.exists ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500'}`;
            document.getElementById('status-text').innerText = d.exists ? "Sur disque" : "Absent";
            delBtn.disabled = !d.exists; delBtn.className = d.exists ? "btn-action bg-red-600 text-white" : "btn-action bg-red-900/50 text-red-500 opacity-20";
            document.getElementById('path-ui').innerText = d.path;
        }

        function syncToEditor() {
            const s = Array.from(document.getElementById('models-ui').selectedOptions); if(s.length === 0) return;
            const o = s[0]; const cleanName = o.value.replace(/^[●○]\s/, "");
            document.getElementById('edit-env').value = document.getElementById('env-ui').value;
            document.getElementById('edit-cat').value = o.dataset.cat.split('/')[0];
            document.getElementById('edit-path').value = BASE_PATH + o.dataset.cat;
            document.getElementById('edit-url').value = o.dataset.url;
            document.getElementById('edit-file').value = cleanName; renderCatalogue(cleanName);
        }

        async function startSmartDownload() {
            const url = document.getElementById('edit-url').value; const path = document.getElementById('edit-path').value.replace(BASE_PATH, "");
            const file = document.getElementById('edit-file').value;
            const r = await fetch('/download', { method:'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url, path, filename: file}) });
            if((await r.json()).status === "ok") addLog(`Téléchargement : ${file}`);
        }

        async function loop() {
            try {
                const tasks = await (await fetch('/progress')).json();
                const completeCount = tasks.filter(t => t.status.includes('complete')).length;
                if (completeCount !== lastCompleteCount) { lastCompleteCount = completeCount; await updateDiskState(); loadModels(); }
                document.getElementById('tasks-ui').innerHTML = tasks.map(t => `<div class="bg-slate-900/80 p-3 rounded-xl border-l-4 ${t.status.includes('error') ? 'border-red-500' : (t.status === 'complete' ? 'border-green-500' : 'border-blue-500')}"><div class="flex justify-between text-[10px] mb-1 font-bold"><span>${t.name}</span><span class="text-blue-300">${t.status.toUpperCase()} ${t.status === 'active' ? '- ' + t.speed : ''}</span></div><div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden"><div class="${t.status.includes('error') ? 'bg-red-500' : (t.status === 'complete' ? 'bg-green-500' : 'bg-blue-500')} h-1 transition-all" style="width:${t.progress}%"></div></div></div>`).join('');
            } catch(e) {}
        }

        async function saveToCatalogue() {
            const env = document.getElementById('edit-env').value; const cat = document.getElementById('edit-cat').value;
            const fullPath = document.getElementById('edit-path').value; const url = document.getElementById('edit-url').value;
            const file = document.getElementById('edit-file').value; const relPath = fullPath.replace(BASE_PATH, "").replace(/^\/+/, "");
            const obj = { name: file, url: url, path: relPath, filename: file };
            if(!cfg[env]) cfg[env] = {}; if(!cfg[env][cat]) cfg[env][cat] = [];
            const idx = cfg[env][cat].findIndex(m => m.filename === file);
            if (idx > -1) cfg[env][cat][idx] = obj; else cfg[env][cat].push(obj);
            const r = await fetch('/save-config', { method: 'POST', body: JSON.stringify(cfg) });
            if((await r.json()).github_sync) showGitHubToast(); loadModels(file); renderCatalogue(file);
        }

        function renderCatalogue(filterFile = null) {
            const list = document.getElementById('catalogue-list'); list.innerHTML = "";
            Object.keys(cfg).forEach(env => Object.keys(cfg[env]).forEach(cat => cfg[env][cat].forEach((m, idx) => {
                if (filterFile && m.filename !== filterFile) return;
                list.innerHTML += `<div class="flex justify-between items-center bg-black/40 p-2 mb-1 border border-white/5 rounded ${filterFile ? 'file-highlight' : ''}"><div class="flex flex-col"><span class="text-blue-400 font-bold uppercase" style="font-size:8px">${env} / ${cat}</span><span class="truncate italic text-slate-300">${m.filename}</span></div><button onclick="removeFromCatalogue('${env}','${cat}',${idx})" class="text-red-500 ml-2"><i class="fas fa-times"></i></button></div>`;
            })));
        }

        async function removeFromCatalogue(e,c,i) { if(confirm('Supprimer du JSON ?')) { cfg[e][c].splice(i, 1); await fetch('/save-config', { method: 'POST', body: JSON.stringify(cfg) }); renderCatalogue(); loadModels(); } }
        async function deleteFromDisk() {
            const s = Array.from(document.getElementById('models-ui').selectedOptions); if(s.length === 0) return;
            const o = s[0]; const name = o.value.replace(/^[●○]\s/, "");
            if(confirm(`Supprimer ${name} ?`)) { await fetch(`/delete?cat=${encodeURIComponent(o.dataset.cat)}&file=${encodeURIComponent(name)}`, {method:'DELETE'}); await updateDiskState(); loadModels(); }
        }
        start();
    </script>
</body>
</html>
